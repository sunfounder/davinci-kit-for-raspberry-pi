.. note::

    ã“ã‚“ã«ã¡ã¯ã€SunFounderã®Raspberry Pi & Arduino & ESP32æ„›å¥½å®¶ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ãï¼Facebookä¸Šã§Raspberry Piã€Arduinoã€ESP32ã«ã¤ã„ã¦ã‚‚ã£ã¨æ·±ãæ˜ã‚Šä¸‹ã’ã€ä»–ã®æ„›å¥½å®¶ã¨äº¤æµã—ã¾ã—ã‚‡ã†ã€‚

    **å‚åŠ ã™ã‚‹ç†ç”±ã¯ï¼Ÿ**

    - **ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆ**ï¼šã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„ãƒãƒ¼ãƒ ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€è²©å£²å¾Œã®å•é¡Œã‚„æŠ€è¡“çš„ãªèª²é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚
    - **å­¦ã³ï¼†å…±æœ‰**ï¼šãƒ’ãƒ³ãƒˆã‚„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’äº¤æ›ã—ã¦ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚
    - **ç‹¬å çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**ï¼šæ–°è£½å“ã®ç™ºè¡¨ã‚„å…ˆè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æ—©æœŸã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚
    - **ç‰¹åˆ¥å‰²å¼•**ï¼šæœ€æ–°è£½å“ã®ç‹¬å å‰²å¼•ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
    - **ç¥­ã‚Šã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚®ãƒ•ãƒˆ**ï¼šã‚®ãƒ•ãƒˆã‚„ç¥æ—¥ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ã€‚

    ğŸ‘‰ ç§ãŸã¡ã¨ä¸€ç·’ã«æ¢ç´¢ã—ã€å‰µé€ ã™ã‚‹æº–å‚™ã¯ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ[|link_sf_facebook|]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»Šã™ãå‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

.. _2.2.6_py_pi5:

2.2.6 MPU6050ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
=================================================

ã¯ã˜ã‚ã«
--------------

MPU-6050ã¯ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã€ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã€ãŠã‚ˆã³ã‚¦ã‚§ã‚¢ãƒ©ãƒ–ãƒ«ã‚»ãƒ³ã‚µãƒ¼å‘ã‘ã«è¨­è¨ˆã•ã‚ŒãŸã€ä¸–ç•Œåˆã‹ã¤å”¯ä¸€ã®6è»¸ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒã‚¤ã‚¹ï¼ˆ3è»¸ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã¨3è»¸ã‚¢ã‚¯ã‚»ãƒ©â€‹â€‹â€‹â€‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ã§ã™ã€‚ä½æ¶ˆè²»é›»åŠ›ã€ä½ã‚³ã‚¹ãƒˆã€é«˜æ€§èƒ½ã®è¦ä»¶ã‚’æŒã¤ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚

ã“ã®å®Ÿé¨“ã§ã¯ã€MPU6050ã®3è»¸åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã¨3è»¸ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã®å€¤ã‚’I2Cã‚’ä½¿ç”¨ã—ã¦å–å¾—ã—ã€ãã‚Œã‚‰ã‚’ç”»é¢ã«è¡¨ç¤ºã—ã¾ã™ã€‚

å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
------------------------------

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚ 

.. image:: ../python_pi5/img/2.2.6_mpu6050_list.png


å›è·¯å›³
-----------------

MPU6050ã¯I2Cãƒã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦ãƒã‚¤ã‚¯ãƒ­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¨é€šä¿¡ã—ã¾ã™ã€‚SDA1ã¨SCL1ã¯å¯¾å¿œã™ã‚‹ãƒ”ãƒ³ã«æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

.. image:: ../python_pi5/img/2.2.6_mpu6050_schematic.png


å®Ÿé¨“æ‰‹é †
-------------------------------

**ã‚¹ãƒ†ãƒƒãƒ— 1:** å›è·¯ã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚

.. image:: ../python_pi5/img/2.2.6_mpu6050_circuit.png


**ã‚¹ãƒ†ãƒƒãƒ— 2:** I2Cã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ï¼ˆAppendix :ref:`i2c_config` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚I2Cã‚’è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚ï¼‰

**ã‚¹ãƒ†ãƒƒãƒ— 3:** ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã€‚

.. raw:: html

   <run></run>

.. code-block::

    cd ~/davinci-kit-for-raspberry-pi/python-pi5

**ã‚¹ãƒ†ãƒƒãƒ— 4:** å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

.. raw:: html

   <run></run>

.. code-block::

    sudo python3 2.2.6_mpu6050_zero.py

ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€MPU6050ã«ã‚ˆã£ã¦èª­ã¿å–ã‚‰ã‚ŒãŸxè»¸ãŠã‚ˆã³yè»¸ã®åè§’ã€ãŠã‚ˆã³åŠ é€Ÿåº¦ã€å„è»¸ã®è§’é€Ÿåº¦ãŒè¨ˆç®—ã•ã‚ŒãŸå¾Œã€ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

.. note::

    * ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ ``FileNotFoundError: [Errno 2] No such file or directory: '/dev/i2c-1'`` ã¨è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã€I2Cã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã« :ref:`i2c_config` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
    * ``ModuleNotFoundError: No module named 'smbus2'`` ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã€ ``sudo pip3 install smbus2`` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
    * ã‚¨ãƒ©ãƒ¼ ``OSError: [Errno 121] Remote I/O error`` ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ¥ç¶šãŒèª¤ã£ã¦ã„ã‚‹ã‹ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚


**ã‚³ãƒ¼ãƒ‰**

.. note::

    ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ **å¤‰æ›´/ãƒªã‚»ãƒƒãƒˆ/ã‚³ãƒ”ãƒ¼/å®Ÿè¡Œ/åœæ­¢** ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€ãã®å‰ã« ``davinci-kit-for-raspberry-pi/python-pi5`` ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹ã«ç§»å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸå¾Œã€åŠ¹æœã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ç›´æ¥å®Ÿè¡Œã§ãã¾ã™ã€‚


.. raw:: html

    <run></run>

.. code-block:: python

   import smbus
   import math
   import time

   # é›»æºç®¡ç†ãƒ¬ã‚¸ã‚¹ã‚¿
   power_mgmt_1 = 0x6b
   power_mgmt_2 = 0x6c

   def read_byte(adr):
       return bus.read_byte_data(address, adr)

   def read_word(adr):
       high = bus.read_byte_data(address, adr)
       low = bus.read_byte_data(address, adr+1)
       val = (high << 8) + low
       return val

   def read_word_2c(adr):
       val = read_word(adr)
       if (val >= 0x8000):
           return -((65535 - val) + 1)
       else:
           return val

   def dist(a,b):
       return math.sqrt((a*a)+(b*b))

   def get_y_rotation(x,y,z):
       radians = math.atan2(x, dist(y,z))
       return -math.degrees(radians)

   def get_x_rotation(x,y,z):
       radians = math.atan2(y, dist(x,z))
       return math.degrees(radians)


   bus = smbus.SMBus(1) # or bus = smbus.SMBus(1) for Revision 2 boards
   address = 0x68       # ã“ã‚Œã¯i2cdetectã‚³ãƒãƒ³ãƒ‰ã§èª­ã¿å–ã‚‰ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹å€¤ã§ã™

   # 6050ã‚’ã‚¹ãƒªãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰èµ·ã“ã—ã¾ã™
   bus.write_byte_data(address, power_mgmt_1, 0)

   while True:
       time.sleep(0.1)
       gyro_xout = read_word_2c(0x43)
       gyro_yout = read_word_2c(0x45)
       gyro_zout = read_word_2c(0x47)

       print ("gyro_xout : ", gyro_xout, " scaled: ", (gyro_xout / 131))
       print ("gyro_yout : ", gyro_yout, " scaled: ", (gyro_yout / 131))
       print ("gyro_zout : ", gyro_zout, " scaled: ", (gyro_zout / 131))

       accel_xout = read_word_2c(0x3b)
       accel_yout = read_word_2c(0x3d)
       accel_zout = read_word_2c(0x3f)

       accel_xout_scaled = accel_xout / 16384.0
       accel_yout_scaled = accel_yout / 16384.0
       accel_zout_scaled = accel_zout / 16384.0

       print ("accel_xout: ", accel_xout, " scaled: ", accel_xout_scaled)
       print ("accel_yout: ", accel_yout, " scaled: ", accel_yout_scaled)
       print ("accel_zout: ", accel_zout, " scaled: ", accel_zout_scaled)

       print ("x rotation: " , get_x_rotation(accel_xout_scaled, accel_yout_scaled, accel_zout_scaled))
       print ("y rotation: " , get_y_rotation(accel_xout_scaled, accel_yout_scaled, accel_zout_scaled))

       time.sleep(1)


**ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜**

1. MPU6050ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚

   .. code-block:: python

       def read_word(adr):
           high = bus.read_byte_data(address, adr)
           low = bus.read_byte_data(address, adr+1)
           val = (high << 8) + low
           return val

       def read_word_2c(adr):
           val = read_word(adr)
           if (val >= 0x8000):
               return -((65535 - val) + 1)
           else:
               return val

2. yè»¸ã®åè§’ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

   .. code-block:: python

       def get_y_rotation(x,y,z):
           radians = math.atan2(x, dist(y,z))
           return -math.degrees(radians)

3. xè»¸ã®åè§’ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

   .. code-block:: python

       def get_x_rotation(x,y,z):
           radians = math.atan2(y, dist(x,z))
           return math.degrees(radians)

4. ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—ã‚»ãƒ³ã‚µãƒ¼ã®xè»¸ã€yè»¸ã€zè»¸ã®å€¤ã‚’èª­ã¿å–ã‚Šã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è§’é€Ÿåº¦ã®å€¤ã«å¤‰æ›ã—ã€ãã‚Œã‚‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

   .. code-block:: python

       gyro_xout = read_word_2c(0x43)
       gyro_yout = read_word_2c(0x45)
       gyro_zout = read_word_2c(0x47)

       print ("gyro_xout : ", gyro_xout, " scaled: ", (gyro_xout / 131))
       print ("gyro_yout : ", gyro_yout, " scaled: ", (gyro_yout / 131))
       print ("gyro_zout : ", gyro_zout, " scaled: ", (gyro_zout / 131))

5. åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã®xè»¸ã€yè»¸ã€zè»¸ã®å€¤ã‚’èª­ã¿å–ã‚Šã€ãã®å€¤ã‚’åŠ é€Ÿåº¦ï¼ˆé‡åŠ›å˜ä½ï¼‰ã«å¤‰æ›ã—ã€ãã‚Œã‚‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

   .. code-block:: python

       accel_xout = read_word_2c(0x3b)
       accel_yout = read_word_2c(0x3d)
       accel_zout = read_word_2c(0x3f)

       accel_xout_scaled = accel_xout / 16384.0
       accel_yout_scaled = accel_yout / 16384.0
       accel_zout_scaled = accel_zout / 16384.0

       print ("accel_xout: ", accel_xout, " scaled: ", accel_xout_scaled)
       print ("accel_yout: ", accel_yout, " scaled: ", accel_yout_scaled)
       print ("accel_zout: ", accel_zout, " scaled: ", accel_zout_scaled)

6. xè»¸ãŠã‚ˆã³yè»¸ã®åè§’ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

   .. code-block:: python

       print ("x rotation: " , get_x_rotation(accel_xout_scaled, accel_yout_scaled, accel_zout_scaled))
       print ("y rotation: " , get_y_rotation(accel_xout_scaled, accel_yout_scaled, accel_zout_scaled))


