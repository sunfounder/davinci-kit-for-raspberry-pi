.. note::

    隆Hola! Bienvenidos a la comunidad de entusiastas de SunFounder para Raspberry Pi, Arduino y ESP32 en Facebook. Sum茅rgete en el mundo de Raspberry Pi, Arduino y ESP32 junto con otros apasionados.

    **驴Por qu茅 unirse?**

    - **Soporte de Expertos**: Soluciona problemas post-venta y desaf铆os t茅cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y Comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Avances Exclusivos**: Accede anticipadamente a anuncios de nuevos productos y adelantos.
    - **Descuentos Especiales**: Disfruta de descuentos exclusivos en nuestros productos m谩s recientes.
    - **Promociones y Sorteos Festivos**: Participa en sorteos y promociones especiales en d铆as festivos.

     驴Listo para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y 煤nete hoy.

2.2.5 M贸dulo Sensor Ultras贸nico
====================================

Introducci贸n
----------------

El sensor ultras贸nico utiliza ondas ultras贸nicas para detectar objetos 
con precisi贸n y medir distancias. Emite ondas ultras贸nicas y las convierte 
en se帽ales electr贸nicas.

Componentes
---------------

.. image:: img/list_2.2.5.png


Principio
--------------

**Ultrasonido**

El m贸dulo de medici贸n ultras贸nica proporciona una funci贸n de medici贸n sin 
contacto de 2 cm a 400 cm, con una precisi贸n de hasta 3 mm. Puede garantizar 
una se帽al estable dentro de 5 m, y esta se va debilitando gradualmente despu茅s 
de esa distancia, hasta desaparecer en la posici贸n de 7 m.

El m贸dulo incluye transmisores y receptores ultras贸nicos, as铆 como un circuito 
de control. Los principios b谩sicos son los siguientes:

(1) Usar un flip-flop IO para procesar una se帽al de nivel alto de al menos 10 碌s.

(2) El m贸dulo env铆a autom谩ticamente ocho ciclos de 40 kHz y detecta si se recibe una se帽al de retorno.

(3) Si la se帽al regresa, pasando al nivel alto, la duraci贸n del nivel alto del IO 
representa el tiempo desde la emisi贸n de la onda ultras贸nica hasta su retorno. 
En este caso, la distancia de prueba = (tiempo de nivel alto x velocidad del 
sonido (340 m/s) / 2).

.. image:: img/image217.png
    :width: 200



.. image:: img/image328.png
    :width: 500



El diagrama de tiempo se muestra a continuaci贸n. Solo necesitas suministrar 
un pulso corto de 10 碌s para la entrada de disparo para iniciar la medici贸n, 
y luego el m贸dulo emitir谩 una r谩faga de 8 ciclos de ultrasonido a 40 kHz y 
generar谩 su eco. Puedes calcular la distancia en funci贸n del intervalo de 
tiempo entre el env铆o de la se帽al de disparo y la recepci贸n del eco.

F贸rmula: 碌s / 58 = cent铆metros o 碌s / 148 = pulgadas; o: la distancia = tiempo 
de nivel alto \* velocidad (340 M/S) / 2; se recomienda usar un ciclo de medici贸n 
superior a 60 ms para evitar colisiones de se帽ales de disparo y eco.

.. image:: img/image218.png
    :width: 800



Diagrama de Circuito
-----------------------

.. image:: img/image329.png


Procedimientos Experimentales
-------------------------------

**Paso 1:** Construye el circuito.

.. image:: img/image220.png
    :width: 800


**Paso 2:** Accede a la carpeta del c贸digo.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/davinci-kit-for-raspberry-pi/c/2.2.5/

**Paso 3:** Compila el c贸digo.

.. raw:: html

   <run></run>

.. code-block::

    gcc 2.2.5_Ultrasonic.c -lwiringPi

**Paso 4:** Ejecuta el archivo ejecutable.

.. raw:: html

   <run></run>

.. code-block::

    sudo ./a.out

Con el c贸digo en ejecuci贸n, el m贸dulo sensor ultras贸nico detectar谩 la 
distancia entre el obst谩culo frente a 茅l y el propio m贸dulo, mostrando 
luego el valor de la distancia en la pantalla.

.. note::

    Si no funciona tras ejecutar el c贸digo, o aparece el mensaje de error: \"wiringPi.h: No such file or directory", consulta :ref:`C code is not working?`.
**C贸digo**

.. code-block:: c

    #include <wiringPi.h>
    #include <stdio.h>
    #include <sys/time.h>

    #define Trig    4
    #define Echo    5

    void ultraInit(void)
    {
        pinMode(Echo, INPUT);
        pinMode(Trig, OUTPUT);
    }

    float disMeasure(void)
    {
        struct timeval tv1;
        struct timeval tv2;
        long time1, time2;
        float dis;

        digitalWrite(Trig, LOW);
        delayMicroseconds(2);

        digitalWrite(Trig, HIGH);
        delayMicroseconds(10);      
        digitalWrite(Trig, LOW);
                                    
        while(!(digitalRead(Echo) == 1));   
        gettimeofday(&tv1, NULL);           

        while(!(digitalRead(Echo) == 0));   
        gettimeofday(&tv2, NULL);           

        time1 = tv1.tv_sec * 1000000 + tv1.tv_usec;   
        time2  = tv2.tv_sec * 1000000 + tv2.tv_usec;

        dis = (float)(time2 - time1) / 1000000 * 34000 / 2;  

        return dis;
    }

    int main(void)
    {
        float dis;
        if(wiringPiSetup() == -1){ //si la inicializaci贸n de wiring falla, muestra mensaje en pantalla
            printf("setup wiringPi failed !");
            return 1;
        }

        ultraInit();
        
        while(1){
            dis = disMeasure();
            printf("%0.2f cm\n\n",dis);
            delay(300);
        }

        return 0;
    }

**Explicaci贸n del C贸digo**

.. code-block:: c

    void ultraInit(void)
    {
        pinMode(Echo, INPUT);
        pinMode(Trig, OUTPUT);
    }

Inicializa los pines del sensor ultras贸nico; en este proceso, se configura Echo como entrada y Trig como salida.

.. code-block:: c

    float disMeasure(void){};

Esta funci贸n permite la medici贸n con el sensor ultras贸nico calculando la distancia de detecci贸n seg煤n el tiempo de retorno.

.. code-block:: c

    struct timeval tv1;
    struct timeval tv2;

La estructura timeval se utiliza para almacenar el tiempo actual. La estructura completa es la siguiente:

.. code-block:: c

    struct timeval
    {
    __time_t tv_sec;        /* Segundos. */
    __suseconds_t tv_usec;  /* Microsegundos. */
    };

Aqu铆, tv_sec representa los segundos desde Epoch en la creaci贸n de struct 
timeval. Tv_usec indica microsegundos o fracciones de segundo.

.. code-block:: c

    digitalWrite(Trig, HIGH);
    delayMicroseconds(10);     
    digitalWrite(Trig, LOW);

Se env铆a un pulso ultras贸nico de 10 碌s.

.. code-block:: c

    while(!(digitalRead(Echo) == 1));
    gettimeofday(&tv1, NULL);

Este bucle vac铆o asegura que, tras el env铆o de la se帽al de disparo, no haya 
interferencias por se帽ales de eco, y luego registra el tiempo actual.

.. code-block:: c

    while(!(digitalRead(Echo) == 0)); 
    gettimeofday(&tv2, NULL);

Este bucle vac铆o asegura que el siguiente paso no se ejecute hasta recibir la 
se帽al de eco y luego registra el tiempo actual.

.. code-block:: c

    time1 = tv1.tv_sec * 1000000 + tv1.tv_usec;
    time2  = tv2.tv_sec * 1000000 + tv2.tv_usec;

Convierte el tiempo almacenado por struct timeval en microsegundos.

.. code-block:: c

    dis = (float)(time2 - time1) / 1000000 * 34000 / 2;  

La distancia se calcula con el intervalo de tiempo y la velocidad de 
propagaci贸n del sonido. Velocidad del sonido en el aire: 34000 cm/s.
