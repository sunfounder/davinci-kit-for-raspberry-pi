.. note::

    隆Hola! Bienvenido a la Comunidad de Entusiastas de Raspberry Pi, Arduino y ESP32 de SunFounder en Facebook. Sum茅rgete en el mundo de Raspberry Pi, Arduino y ESP32 junto a otros entusiastas.

    **驴Por qu茅 unirse?**

    - **Soporte de Expertos**: Resuelve problemas postventa y desaf铆os t茅cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y Comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Avances Exclusivos**: Obt茅n acceso anticipado a anuncios de nuevos productos y adelantos exclusivos.
    - **Descuentos Especiales**: Disfruta de descuentos exclusivos en nuestros productos m谩s recientes.
    - **Promociones Festivas y Sorteos**: Participa en sorteos y promociones especiales durante las festividades.

     驴Listo para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y 煤nete hoy mismo.

2.2.5 M贸dulo Sensor Ultras贸nico
===================================

Introducci贸n
----------------

El sensor ultras贸nico utiliza ondas ultras贸nicas para detectar objetos 
con precisi贸n y medir distancias. Emite ondas ultras贸nicas y las convierte 
en se帽ales electr贸nicas.

Componentes
----------------

.. image:: img/list_2.2.5.png

Principio
------------

**Ultrasonido**

El m贸dulo de rango ultras贸nico proporciona una funci贸n de medici贸n sin contacto 
de 2 cm a 400 cm, con una precisi贸n de hasta 3 mm. Puede asegurar que la se帽al 
sea estable dentro de los 5 metros y se va debilitando gradualmente hasta 
desaparecer alrededor de los 7 metros.

El m贸dulo incluye transmisores ultras贸nicos, receptor y circuito de control. 
Los principios b谩sicos son los siguientes:

1. Usar un flip-flop de IO para procesar una se帽al de alto nivel de al menos 
10 us.

2. El m贸dulo env铆a autom谩ticamente ocho pulsos de 40 kHz y detecta si hay un 
retorno de se帽al de pulso.

3. Si la se帽al retorna, pasando al nivel alto, la duraci贸n de salida alta del 
IO es el tiempo desde la transmisi贸n de la onda ultras贸nica hasta su retorno. 
Aqu铆, la distancia de prueba = (tiempo alto x velocidad del sonido (340 m/s) / 2.

.. image:: img/image217.png
    :width: 200



.. image:: img/image328.png
    :width: 500

El diagrama de tiempos se muestra a continuaci贸n. Solo necesitas suministrar 
un pulso corto de 10 us para la entrada de disparo para iniciar la medici贸n. 
Luego, el m贸dulo enviar谩 una r谩faga de 8 ciclos de ultrasonido a 40 kHz y 
elevar谩 su eco. Puedes calcular la distancia a trav茅s del intervalo de tiempo 
entre el env铆o de la se帽al de disparo y la recepci贸n de la se帽al de eco.

F贸rmula: us / 58 = cent铆metros o us / 148 = pulgadas; o: rango = tiempo de nivel 
alto * velocidad (340M/S) / 2; se sugiere usar un ciclo de medici贸n superior a 
60 ms para prevenir colisiones de se帽al entre la se帽al de disparo y la se帽al de eco.

.. image:: img/image218.png
    :width: 800

Diagrama Esquem谩tico
----------------------

.. image:: img/image329.png


Procedimientos Experimentales
-------------------------------

**Paso 1:** Construye el circuito.

.. image:: img/image220.png
    :width: 800

Para Usuarios de Lenguaje C
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

**Paso 2:** Dir铆gete a la carpeta del c贸digo.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/davinci-kit-for-raspberry-pi/c/2.2.5/

**Paso 3:** Compila el c贸digo.

.. raw:: html

   <run></run>

.. code-block::

    gcc 2.2.5_Ultrasonic.c -lwiringPi

**Paso 4:** Ejecuta el archivo compilado.

.. raw:: html

   <run></run>

.. code-block::

    sudo ./a.out

Con el c贸digo en ejecuci贸n, el m贸dulo de sensor ultras贸nico detectar谩 la 
distancia entre el obst谩culo enfrente y el propio m贸dulo, y el valor de la 
distancia se imprimir谩 en la pantalla.

.. note::

    Si no funciona despu茅s de ejecutar, o aparece un mensaje de error: \"wiringPi.h: No such file or directory\", consulta :ref:`C code is not working?`.
**C贸digo**

.. code-block:: c

    #include <wiringPi.h>
    #include <stdio.h>
    #include <sys/time.h>

    #define Trig    4
    #define Echo    5

    void ultraInit(void)
    {
        pinMode(Echo, INPUT);
        pinMode(Trig, OUTPUT);
    }

    float disMeasure(void)
    {
        struct timeval tv1;
        struct timeval tv2;
        long time1, time2;
        float dis;

        digitalWrite(Trig, LOW);
        delayMicroseconds(2);

        digitalWrite(Trig, HIGH);
        delayMicroseconds(10);      
        digitalWrite(Trig, LOW);
                                    
        while(!(digitalRead(Echo) == 1));   
        gettimeofday(&tv1, NULL);           

        while(!(digitalRead(Echo) == 0));   
        gettimeofday(&tv2, NULL);           

        time1 = tv1.tv_sec * 1000000 + tv1.tv_usec;   
        time2  = tv2.tv_sec * 1000000 + tv2.tv_usec;

        dis = (float)(time2 - time1) / 1000000 * 34000 / 2;  

        return dis;
    }

    int main(void)
    {
        float dis;
        if(wiringPiSetup() == -1){ // si la inicializaci贸n de wiring falla, muestra mensaje en pantalla
            printf("setup wiringPi failed !");
            return 1;
        }

        ultraInit();
        
        while(1){
            dis = disMeasure();
            printf("%0.2f cm\n\n",dis);
            delay(300);
        }

        return 0;
    }

**Explicaci贸n del C贸digo**

.. code-block:: c

    void ultraInit(void)
    {
        pinMode(Echo, INPUT);
        pinMode(Trig, OUTPUT);
    }

Inicializa el pin ultras贸nico; al mismo tiempo, configura Echo como entrada y Trig como salida.

.. code-block:: c

    float disMeasure(void){};

Esta funci贸n se utiliza para calcular la distancia detectada mediante el 
sensor ultras贸nico.

.. code-block:: c

    struct timeval tv1;
    struct timeval tv2;

Struct timeval es una estructura usada para almacenar la hora actual. 
La estructura completa es la siguiente:

.. code-block:: c

    struct timeval
    {
    __time_t tv_sec;        /* Segundos. */
    __suseconds_t tv_usec;  /* Microsegundos. */
    };

Aqu铆, tv_sec representa los segundos transcurridos desde Epoch al crear 
struct timeval. Tv_usec representa microsegundos o una fracci贸n de segundos.

.. code-block:: c

    digitalWrite(Trig, HIGH);
    delayMicroseconds(10);     
    digitalWrite(Trig, LOW);

Se env铆a un pulso ultras贸nico de 10us.

.. code-block:: c

    while(!(digitalRead(Echo) == 1));
    gettimeofday(&tv1, NULL);

Este bucle vac铆o asegura que cuando se env铆a la se帽al de disparo, no haya 
una se帽al de eco interferente y luego obtiene la hora actual.

.. code-block:: c

    while(!(digitalRead(Echo) == 0)); 
    gettimeofday(&tv2, NULL);

Este bucle vac铆o asegura que no se ejecute el siguiente paso hasta que se 
reciba la se帽al de eco y luego obtiene la hora actual.

.. code-block:: c

    time1 = tv1.tv_sec * 1000000 + tv1.tv_usec;
    time2  = tv2.tv_sec * 1000000 + tv2.tv_usec;

Convierte el tiempo almacenado por struct timeval en microsegundos completos.

.. code-block:: c

    dis = (float)(time2 - time1) / 1000000 * 34000 / 2;  

La distancia se calcula mediante el intervalo de tiempo y la velocidad de 
propagaci贸n del sonido. La velocidad del sonido en el aire es de 34000 cm/s.

Para Usuarios de Python
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

**Paso 2:** Ve a la carpeta del c贸digo.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/davinci-kit-for-raspberry-pi/python/

**Paso 3:** Ejecuta el archivo.

.. raw:: html

   <run></run>

.. code-block::

    sudo python3 2.2.5_Ultrasonic.py

Al ejecutar el c贸digo, el m贸dulo de sensor ultras贸nico detectar谩 la distancia
entre el obst谩culo y el m贸dulo, y el valor de la distancia se mostrar谩 en la pantalla.


**C贸digo**

.. note::

    Puedes **Modificar/Restablecer/Copiar/Ejecutar/Detener** el c贸digo a continuaci贸n. Pero antes, debes ir a la ruta del c贸digo fuente como ``davinci-kit-for-raspberry-pi/python``.
    
.. raw:: html

   <run></run>

.. code-block:: python

    import RPi.GPIO as GPIO
    import time

    TRIG = 16
    ECHO = 18

    def setup():
        GPIO.setmode(GPIO.BOARD)
        GPIO.setup(TRIG, GPIO.OUT)
        GPIO.setup(ECHO, GPIO.IN)

    def distance():
        GPIO.output(TRIG, 0)
        time.sleep(0.000002)

        GPIO.output(TRIG, 1)
        time.sleep(0.00001)
        GPIO.output(TRIG, 0)

        
        while GPIO.input(ECHO) == 0:
            a = 0
        time1 = time.time()
        while GPIO.input(ECHO) == 1:
            a = 1
        time2 = time.time()

        during = time2 - time1
        return during * 340 / 2 * 100

    def loop():
        while True:
            dis = distance()
            print ('Distance: %.2f' % dis)
            time.sleep(0.3)

    def destroy():
        GPIO.cleanup()

    if __name__ == "__main__":
        setup()
        try:
            loop()
        except KeyboardInterrupt:
            destroy()

**Explicaci贸n del C贸digo**

.. code-block:: python

    def distance():

Esta funci贸n se utiliza para implementar la funcionalidad del sensor ultras贸nico 
calculando la distancia detectada.

.. code-block:: python

    GPIO.output(TRIG, 1)
    time.sleep(0.00001)
    GPIO.output(TRIG, 0)

Este fragmento env铆a un pulso ultras贸nico de 10us.

.. code-block:: python

    while GPIO.input(ECHO) == 0:
        a = 0
    time1 = time.time()

Este bucle vac铆o asegura que, cuando se env铆e la se帽al de disparo, no haya 
se帽ales de eco interferentes, y luego obtiene la hora actual.

.. code-block:: python

    while GPIO.input(ECHO) == 1:
        a = 1
    time2 = time.time()

Este bucle vac铆o asegura que no se ejecute el siguiente paso hasta que se reciba 
la se帽al de eco, y luego obtiene la hora actual.

.. code-block:: python

    during = time2 - time1

Ejecuta el c谩lculo del intervalo de tiempo.

.. code-block:: python

    return during * 340 / 2 * 100

La distancia se calcula en funci贸n del intervalo de tiempo y la velocidad 
de propagaci贸n del sonido. Velocidad del sonido en el aire: 340m/s.

Imagen del Fen贸meno
------------------------

.. image:: img/image221.jpeg