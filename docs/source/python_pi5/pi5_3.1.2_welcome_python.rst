.. note::

    ¬°Hola! Bienvenido a la comunidad de entusiastas de SunFounder para Raspberry Pi, Arduino y ESP32 en Facebook. √önete a otros apasionados y profundiza en el uso de Raspberry Pi, Arduino y ESP32.

    **¬øPor qu√© unirte?**

    - **Soporte de expertos**: Resuelve problemas postventa y desaf√≠os t√©cnicos con la ayuda de nuestra comunidad y equipo.
    - **Aprende y comparte**: Intercambia consejos y tutoriales para mejorar tus habilidades.
    - **Avances exclusivos**: Obt√©n acceso anticipado a anuncios de nuevos productos y adelantos exclusivos.
    - **Descuentos especiales**: Disfruta de descuentos exclusivos en nuestros productos m√°s recientes.
    - **Promociones festivas y sorteos**: Participa en sorteos y promociones de temporada.

    üëâ ¬øListo para explorar y crear con nosotros? Haz clic en [|link_sf_facebook|] y √∫nete hoy mismo.

.. _py_pi5_welcome:

3.1.2 Bienvenido
================

Introducci√≥n
----------------

En este proyecto, usaremos un sensor PIR para detectar el movimiento de los 
peatones y utilizaremos servos, LED y un timbre para simular el funcionamiento 
de la puerta autom√°tica en una tienda de conveniencia. Cuando un peat√≥n aparezca 
dentro del rango de detecci√≥n del PIR, se encender√° la luz indicadora, la puerta 
se abrir√° y el timbre reproducir√° una melod√≠a de bienvenida.

Componentes necesarios
-------------------------

En este proyecto, necesitamos los siguientes componentes.

.. image:: ../python_pi5/img/4.1.8_welcome_list.png
    :width: 800
    :align: center

.. Es definitivamente conveniente comprar un kit completo; aqu√≠ tienes el enlace:

.. .. list-table::
..     :widths: 20 20 20
..     :header-rows: 1

..     *   - Nombre
..         - ELEMENTOS EN ESTE KIT
..         - ENLACE
..     *   - Kit Raphael
..         - 337
..         - |link_Raphael_kit|

.. Tambi√©n puedes comprarlos por separado en los enlaces a continuaci√≥n.

.. .. list-table::
..     :widths: 30 20
..     :header-rows: 1

..     *   - INTRODUCCI√ìN AL COMPONENTE
..         - ENLACE DE COMPRA

..     *   - :ref:`gpio_extension_board`
..         - |link_gpio_board_buy|
..     *   - :ref:`breadboard`
..         - |link_breadboard_buy|
..     *   - :ref:`wires`
..         - |link_wires_buy|
..     *   - :ref:`resistor`
..         - |link_resistor_buy|
..     *   - :ref:`led`
..         - |link_led_buy|
..     *   - :ref:`pir`
..         - \-
..     *   - :ref:`servo`
..         - |link_servo_buy|
..     *   - :ref:`Buzzer`
..         - |link_passive_buzzer_buy|
..     *   - :ref:`transistor`
..         - |link_transistor_buy|


Diagrama esquem√°tico
-------------------------

============ ======== ======== ===
T-Board Name physical wiringPi BCM
GPIO18       Pin 12   1        18
GPIO17       Pin 11   0        17
GPIO27       Pin 13   2        27
GPIO22       Pin 15   3        22
============ ======== ======== ===

.. image:: ../python_pi5/img/4.1.8_welcome_schematic.png
   :align: center

Procedimientos experimentales
----------------------------------

**Paso 1:** Construye el circuito.

.. image:: ../python_pi5/img/4.1.8_welcome_circuit.png
    :align: center

**Paso 2:** Cambia al directorio del c√≥digo.

.. raw:: html

   <run></run>

.. code-block::

    cd ~/davinci-kit-for-raspberry-pi/python-pi5

**Paso 3:** Ejecuta el programa.

.. raw:: html

   <run></run>

.. code-block::

    sudo python3 3.1.2_Welcome.py

Despu√©s de ejecutar el c√≥digo, si el sensor PIR detecta que alguien pasa, 
la puerta se abrir√° autom√°ticamente (simulada por el servo), se encender√° 
la luz indicadora y sonar√° la m√∫sica de bienvenida. Despu√©s de que termine 
la m√∫sica, el sistema cerrar√° autom√°ticamente la puerta y apagar√° la luz, 
esperando a la pr√≥xima persona que pase.

El m√≥dulo PIR tiene dos potenci√≥metros: uno para ajustar la sensibilidad y 
otro para ajustar la distancia de detecci√≥n. Para mejorar el funcionamiento 
del m√≥dulo PIR, g√≠ralos ambos en sentido contrario a las agujas del reloj hasta el final.

.. image:: ../python_pi5/img/4.1.8_PIR_TTE.png
    :width: 400
    :align: center

.. warning::

    Si aparece el mensaje de error ``RuntimeError: Cannot determine SOC peripheral base address``, consulta :ref:`faq_soc`

**C√≥digo**

.. note::
    Puedes **Modificar/Restablecer/Copiar/Ejecutar/Detener** el c√≥digo a continuaci√≥n. Pero antes, debes ir a la ruta del c√≥digo fuente como ``raphael-kit/python-pi5``. Despu√©s de modificar el c√≥digo, puedes ejecutarlo directamente para ver el efecto.

.. raw:: html

    <run></run>

.. code-block:: python

   #!/usr/bin/env python3

   from gpiozero import LED, MotionSensor, Servo, TonalBuzzer
   import time

   # Configuraci√≥n de pines GPIO para el LED, sensor de movimiento (PIR) y buzzer
   ledPin = LED(6)
   pirPin = MotionSensor(21)
   buzPin = TonalBuzzer(27)

   # Factor de correcci√≥n de ancho de pulso del servo y c√°lculo
   myCorrection = 0.45
   maxPW = (2.0 + myCorrection) / 1000  # Ancho de pulso m√°ximo
   minPW = (1.0 - myCorrection) / 1000  # Ancho de pulso m√≠nimo

   # Inicializar el servo con anchos de pulso personalizados
   servoPin = Servo(25, min_pulse_width=minPW, max_pulse_width=maxPW)

   # Melod√≠a para el buzzer, con notas y duraciones
   tune = [('C#4', 0.2), ('D4', 0.2), (None, 0.2),
           ('Eb4', 0.2), ('E4', 0.2), (None, 0.6),
           ('F#4', 0.2), ('G4', 0.2), (None, 0.6),
           ('Eb4', 0.2), ('E4', 0.2), (None, 0.2),
           ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
           ('C4', 0.2), ('B4', 0.2), (None, 0.2),
           ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
           ('B4', 0.2), ('Bb4', 0.5), (None, 0.6),
           ('A4', 0.2), ('G4', 0.2), ('E4', 0.2), 
           ('D4', 0.2), ('E4', 0.2)]

   def setAngle(angle):
       """
       Move the servo to a specified angle.
       :param angle: Angle in degrees (0-180).
       """
       value = float(angle / 180)  # Convierte el √°ngulo a valor de servo
       servoPin.value = value      # Ajusta la posici√≥n del servo
       time.sleep(0.001)           # Breve pausa para el movimiento del servo

   def doorbell():
       """
       Play a musical tune using the buzzer.
       """
       for note, duration in tune:
           buzPin.play(note)       # Reproduce la nota
           time.sleep(float(duration))  # Duraci√≥n de la nota
       buzPin.stop()               # Detiene el buzzer despu√©s de la melod√≠a

   def closedoor():
       # Apaga el LED y mueve el servo para cerrar la puerta
       ledPin.off()
       for i in range(180, -1, -1):
           setAngle(i)             # Mueve el servo de 180 a 0 grados
           time.sleep(0.001)       # Breve pausa para un movimiento suave
       time.sleep(1)               # Espera despu√©s de cerrar la puerta

   def opendoor():
       # Enciende el LED, abre la puerta (mueve el servo), reproduce la melod√≠a y luego cierra la puerta
       ledPin.on()
       for i in range(0, 181):
           setAngle(i)             # Mueve el servo de 0 a 180 grados
           time.sleep(0.001)       # Breve pausa para un movimiento suave
       time.sleep(1)               # Espera antes de reproducir la melod√≠a
       doorbell()                  # Reproduce la melod√≠a de bienvenida
       closedoor()                 # Cierra la puerta despu√©s de la melod√≠a

   def loop():
       # Bucle principal para verificar movimiento y operar la puerta
       while True:
           if pirPin.motion_detected:
               opendoor()               # Abre la puerta si se detecta movimiento
           time.sleep(0.1)              # Breve pausa en el bucle

   try:
       loop()
   except KeyboardInterrupt:
       # Limpia los GPIO en caso de interrupci√≥n del usuario (e.g., Ctrl+C)
       buzPin.stop()
       ledPin.off()


**Explicaci√≥n del C√≥digo**

#. El script comienza importando los m√≥dulos necesarios. La biblioteca ``gpiozero`` se usa para interactuar con el LED, el sensor de movimiento, el servo y el zumbador tonal. El m√≥dulo ``time`` permite manejar funciones relacionadas con el tiempo.

   .. code-block:: python

       #!/usr/bin/env python3
       from gpiozero import LED, MotionSensor, Servo, TonalBuzzer
       import time

#. Inicializa el LED, el sensor de movimiento PIR y el zumbador tonal en sus respectivos pines GPIO.

   .. code-block:: python

       # Configuraci√≥n de pines GPIO para LED, sensor de movimiento (PIR) y zumbador
       ledPin = LED(6)
       pirPin = MotionSensor(21)
       buzPin = TonalBuzzer(27)

#. Calcula los anchos de pulso m√°ximo y m√≠nimo para el servo, incorporando un factor de correcci√≥n para ajustes precisos.

   .. code-block:: python

       # Factor de correcci√≥n y c√°lculo de ancho de pulso para el servo
       myCorrection = 0.45
       maxPW = (2.0 + myCorrection) / 1000  # Ancho de pulso m√°ximo
       minPW = (1.0 - myCorrection) / 1000  # Ancho de pulso m√≠nimo

#. Inicializa el motor del servo en el pin GPIO 25 con los anchos de pulso personalizados para una posici√≥n precisa.

   .. code-block:: python

       # Inicializar el servo con anchos de pulso personalizados
       servoPin = Servo(25, min_pulse_width=minPW, max_pulse_width=maxPW)

#. La melod√≠a se define como una secuencia de notas (frecuencia) y duraciones (segundos).

   .. code-block:: python

       # Melod√≠a para el zumbador, con notas y duraciones
       tune = [('C#4', 0.2), ('D4', 0.2), (None, 0.2),
               ('Eb4', 0.2), ('E4', 0.2), (None, 0.6),
               ('F#4', 0.2), ('G4', 0.2), (None, 0.6),
               ('Eb4', 0.2), ('E4', 0.2), (None, 0.2),
               ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
               ('C4', 0.2), ('B4', 0.2), (None, 0.2),
               ('F#4', 0.2), ('G4', 0.2), (None, 0.2),
               ('B4', 0.2), ('Bb4', 0.5), (None, 0.6),
               ('A4', 0.2), ('G4', 0.2), ('E4', 0.2), 
               ('D4', 0.2), ('E4', 0.2)]

#. Funci√≥n para mover el servo a un √°ngulo espec√≠fico. Convierte el √°ngulo a un valor entre 0 y 1 para el servo.

   .. code-block:: python

       def setAngle(angle):
           """
           Move the servo to a specified angle.
           :param angle: Angle in degrees (0-180).
           """
           value = float(angle / 180)  # Convierte el √°ngulo a valor de servo
           servoPin.value = value      # Establece la posici√≥n del servo
           time.sleep(0.001)           # Breve pausa para el movimiento del servo

#. Funci√≥n para reproducir una melod√≠a utilizando el zumbador. Itera a trav√©s de la lista ``tune``, reproduciendo cada nota durante su duraci√≥n especificada.

   .. code-block:: python

       def doorbell():
           """
           Play a musical tune using the buzzer.
           """
           for note, duration in tune:
               buzPin.play(note)       # Reproduce la nota
               time.sleep(float(duration))  # Duraci√≥n de la nota
           buzPin.stop()               # Detiene el zumbador despu√©s de la melod√≠a

#. Funciones para abrir y cerrar la puerta utilizando el motor del servo. La funci√≥n ``opendoor`` enciende el LED, abre la puerta, reproduce la melod√≠a y luego cierra la puerta.

   .. code-block:: python

       def closedoor():
           # Apaga el LED y mueve el servo para cerrar la puerta
           ledPin.off()
           for i in range(180, -1, -1):
               setAngle(i)             # Mueve el servo de 180 a 0 grados
               time.sleep(0.001)       # Breve pausa para un movimiento suave
           time.sleep(1)               # Espera despu√©s de cerrar la puerta

       def opendoor():
           # Enciende el LED, abre la puerta (mueve el servo), reproduce la melod√≠a y cierra la puerta
           ledPin.on()
           for i in range(0, 181):
               setAngle(i)             # Mueve el servo de 0 a 180 grados
               time.sleep(0.001)       # Breve pausa para un movimiento suave
           time.sleep(1)               # Espera antes de reproducir la melod√≠a
           doorbell()                  # Reproduce la melod√≠a de bienvenida
           closedoor()                 # Cierra la puerta despu√©s de la melod√≠a

#. Bucle principal que verifica constantemente la detecci√≥n de movimiento. Cuando se detecta movimiento, activa la funci√≥n ``opendoor``.

   .. code-block:: python

       def loop():
           # Bucle principal para verificar movimiento y operar la puerta
           while True:
               if pirPin.motion_detected:
                   opendoor()               # Abre la puerta si se detecta movimiento
               time.sleep(0.1)              # Breve pausa en el bucle

#. Ejecuta el bucle principal y asegura que el script pueda detenerse con un comando de teclado (Ctrl+C), apagando el zumbador y el LED para una salida limpia.

   .. code-block:: python

       try:
           loop()
       except KeyboardInterrupt:
           # Limpia los GPIO en caso de interrupci√≥n del usuario (e.g., Ctrl+C)
           buzPin.stop()
           ledPin.off()

